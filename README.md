
## 1\.背景


今天开始更新分布式的文章，工作几年后还没系统的学习分布式的内容，趁着还有时间学习沉淀的时候多输出些文章


## 2\.为什么需要分布式共识算法


`思考：现在你有一份随时变动的数据，需要确保它正确存储在网络的几台不同机器上，并且要保证数据是随时可用的，应该怎么做？`


在分布式环境下，可以不必去追求系统内所有节点在任何情况下的数据状态都一致，采用“少数服从多数”的原则，认为数据的变化被正确存储在系统中。因此，我们需要一种算法，能够让分布式系统内部暂时容忍节点存在不同的状态，但最终大多数节点的状态能够一致。


这种让系统能最终表现出整体一致性的过程，急救室各个节点的**协商共识**


## 3\.Paxos算法的历史


简单写下Paxos算法的历史，最早是由Leslie Lamport（就是大名鼎鼎的LaTeX中的“La”）提出的一种基于消息传递的协商共识算法。


Lamport 在 1990 年首次发表了 Paxos 算法，选的论文题目就是“The Part\-Time Parliament”。但是由于论文使用了希腊城邦的比喻，使得论文更为晦涩难懂，审稿人要求Lamport进行修改，Lamport 非常不爽，然后干脆就撤稿不发了。 2001 年，Lamport 在“SIGACT News”杂志上发表了这篇论文，并放弃了“希腊城邦”的比喻。


之后，2006 年，Google 的 Chubby、Megastore 和 Spanner 等分布式系统，都使用 Paxos 解决了分布式共识的问题，这才使得Paxos 算法一夜间成为计算机科学分布式这条分支中，最炙手可热网红概念。


## 4\.Basic Paxos算法工作流程


Basic Paxos算法将分布式系统中的节点分为提案节点、决策节点和记录节点三类


* **提案节点Proposer**：提出对某个值进行设置操作的节点，设置值这个行为就像提案，值设置成功后，不可变也不会丢失
* **决策节点Acceptor**：应答提案的节点，需要对提案进行投票，同时需要记住自己的投票历史
* **记录节点Learner**：超过半数决策节点就某个提案达成了共识，那么记录节点就需要接受这个提案，并就该提议作出运算，然后将运算结果返回给客户端


![](https://img2024.cnblogs.com/blog/2784584/202412/2784584-20241208213637498-1767257901.png)
### 4\.1Paxos算法怎么解决并发操作带来的竞争？


分布式环境下，一个节点取得锁后，如果在释放锁之前发生崩溃，整个操作都会被无限期等待阻塞。


Paxos解决竞争分2个阶段：


**准备Prepare**：提案节点先广播一个Prepare请求，并附带一个全局数字n作为提案ID，决策节点收到请求后，“**两个承诺，一个应答**”。**承诺**不在接收提案ID小于等于n的Prepare请求，也**承诺**不再接收小于n的Accept请求。**应答**已经批准过的提案中ID最大的那个。


**批准Accept**：提案节点收到多数派的应答后，会有两种结果：


* 所有响应的决策节点此前没有批准过这个值，即**首次设值**的情况，那就自己随意选定值与提案ID，广播给决策节点
* 响应决策节点中，已有至少一个节点的应答中包含有值了，**非首次设值**的情况，那么需要从应答中找出提案ID最大的那个值，再广播。协商共识结束


![](https://img2024.cnblogs.com/blog/2784584/202412/2784584-20241208213712756-385026756.png)
Basic Paxos 只能对单个值形成决议，并且决议的形成至少需要两次网络请求和应答（准备和批准阶段各一次），高并发情况下可能形成活锁。现在只做理论学习就行了。下面讲Multi Paxos算法。


## 5\.Multi Paxos共识算法


### 5\.1核心改进


概念：Multi\-Paxos 只是一种思想，这种思想的核心就是通过多个 Basic Paxos 实例就一系列值达成共识。


相比较Basic Paxos算法，Multi Paxos增加了`选主`的过程：


* 提案节点发现没有主提案节点时，使用准备、批准两轮网络交互，向其他节点广播自己竞选主节点请求
* 得到决策节点多数派的批准时，竞选主节点成功。


选主之后，所有客户端请求都会由主节点来完成提案，不再需要准备过程，只需要 执行批准交互即可：


![](https://img2024.cnblogs.com/blog/2784584/202412/2784584-20241208213751975-354791631.png)
### 5\.2只有主从节点


有了主节点后，角色可以简化，不再区分提案、决策、记录节点。只区分主、从节点。


![](https://img2024.cnblogs.com/blog/2784584/202412/2784584-20241208213820994-1393107258.png)
于是，分布式系统中如何对某个值达成一致 的问题可以分为3部分解决：


* 如何选主
* 如何把数据复制到各个节点上
* 怎么保证过程是安全的


3个问题解决了，就达成共识了。


这里针对问题2和问题3写些内容，用于应对可能的面试：


**问题2：数据复制的过程？**


* 主节点将 X 写入自己的变更日志，但先不提交，接着把变更 X 的信息在下一次心跳包中广播给所有的从节点，并要求从节点回复“确认收到”的消息；
* 从节点收到信息后，将操作写入自己的变更日志，然后给主节点发送“确认签收”的消息；
* 主节点收到过半数的签收消息后，提交自己的变更、应答客户端并且给从节点广播“可以提交”的消息；
* 从节点收到提交消息后提交自己的变更，数据在节点间的复制宣告完成。


**问题3：过程是安全的？**


* 协定性Safety：保证选主的结果一定有且只有唯一的主节点
* 终止性Liveness：保证选主过程一定是在某一时刻能够结束的


从极客时间课程原文上没理解清楚这段的解释，先空着吧，后面理解了再修改这段


## 总结


Paxos 算法不直接应用于工业界，理解原理理论就行。它的变体算法，比如我们今天学习的 Multi Paxos、Raft 算法，以及没有提到的 ZAB 等算法，都是分布式领域中的基石。


 本博客参考[蓝猫机场](https://fenfang.org)。转载请注明出处！
